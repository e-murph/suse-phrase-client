= 自签名证书
:revdate: 2025-07-29
:page-revdate: {revdate}
:description: SUSE Observability 自助托管

== SUSE Observability 服务器

=== 使用自签名证书公开 SUSE Observability 服务器

xref:k8s-suse-rancher-prime.adoc#_installation[SUSE Observability Server]组件不能自行终止 SSL，必须使用受 SSL 保护的导入控制器或负载平衡器，才能通过 HTTPS 公开服务。本节介绍如何使用自签名证书配置输入控制器。

==== 使用 TLS 的输入控制器

要使用https://kubernetes.github.io/ingress-nginx/[Ingress Controller] Nginx和自签名证书公开 SUSE Observability 服务器，您需要

1. 使用服务器证书和密钥创建 Kubernetes TLS 秘密
2. 使用 TLS 设置配置输入资源
3. 部署 SUSE Observability Server 并启用 Ingress

===== 创建 TLS 秘密

从证书和私钥文件创建 Kubernetes TLS 秘密：

[,bash]
----
# Create TLS secret for main SUSE Observability Server
kubectl create secret tls tls-secret \
  --cert=server.crt \
  --key=server.key \
  --namespace suse-observability

# Create TLS secret for OTLP GRPC endpoint
kubectl create secret tls otlp-tls-secret \
  --cert=otlp-server.crt \
  --key=otlp-server.key \
  --namespace suse-observability

# Create TLS secret for OTLP HTTP endpoint
kubectl create secret tls otlp-http-tls-secret \
  --cert=otlp-http-server.crt \
  --key=otlp-http-server.key \
  --namespace suse-observability
----

===== 舵值配置

创建包含 Ingress 配置的值文件（如`ingress-with-tls-values.yaml` ）：

[NOTE]
====
*请注意：*
该配置专用于https://kubernetes.github.io/ingress-nginx/[输入控制器] Nginx。如果您使用的是不同的 Ingress Controller，请相应调整注释和配置。
====

[,yaml]
----
ingress:
  enabled: true
  ingressClassName: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
  hosts:
    - host: suse-observability.MY_DOMAIN
  tls:
    - hosts:
        - suse-observability.MY_DOMAIN
      secretName: tls-secret

opentelemetry-collector:
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      nginx.ingress.kubernetes.io/proxy-body-size: "50m"
      nginx.ingress.kubernetes.io/backend-protocol: GRPC
    hosts:
      - host: otlp-suse-observability.MY_DOMAIN
        paths:
          - path: /
            pathType: Prefix
            port: 4317
    tls:
      - hosts:
          - otlp-suse-observability.MY_DOMAIN
        secretName: otlp-tls-secret
    additionalIngresses:
      - name: otlp-http
        annotations:
          nginx.ingress.kubernetes.io/proxy-body-size: "50m"
        hosts:
          - host: otlp-http-suse-observability.MY_DOMAIN
            paths:
              - path: /
                pathType: Prefix
                port: 4318
        tls:
          - hosts:
              - otlp-http-suse-observability.MY_DOMAIN
            secretName: otlp-http-tls-secret
----

===== 使用 Ingress 安装

使用入口配置部署 SUSE Observability Server：

[,bash]
----
helm upgrade --install \
  --namespace suse-observability \
  --create-namespace \
  --values ingress-with-tls-values.yaml \
  suse-observability \
  suse-observability/suse-observability
----

有关完整的安装说明，请参阅xref:k8s-suse-rancher-prime.adoc#_installation[安装]。

=== 使用自签名证书连接外部系统的 SUSE Observability Server

[NOTE]
====
本节用于配置 SUSE Observability Server 信任使用自签名证书的外部系统。当服务器需要使用自签名证书与外部服务（如网络钩子）建立外部连接时，就需要使用这种方法。
====

SUSE Observability Server 与外部系统有多个交互点。例如，事件处理程序可以呼叫其他系统中的网络钩子。在默认配置下，如果这些系统使用自签名证书或 JVM 默认不信任的证书进行 TLS 加密，SUSE Observability Server 将无法与它们通信。

为缓解这一问题，SUSE Observability Server 允许配置自定义信任存储。

=== 创建自定义信任存储

您需要有可用的自定义 TLS 证书。如果没有，则需要xref:/use/security/self-signed-certificates.adoc#_retrieve_certificate_via_the_browser[通过浏览器检索]。

使用 keytool 工具和 JVM（Java 虚拟机）安装程序中包含的`cacerts` 文件，将现有 TLS 证书文件转换为 SUSE Observability Server 所需的格式。您可以在任何机器上运行，无论操作系统类型如何。

如果电脑上没有安装 JVM，也可以xref:/use/security/self-signed-certificates.adoc#_using_a_docker_jvm[使用 JVM Docker 镜像]来代替。

==== 使用已安装的 JVM

在计算机上安装了 JVM 并将证书保存为一个文件`site.cert` 后，您就可以利用 JVM 的信任存储并添加额外的证书来创建一个新的信任存储。

. 创建工作目录`workdir` ，并将证书文件`site.cert` 复制到该目录。
. 将目录更改为`workdir` ，并复制 Java 安装中的`cacerts` 文件。`$JAVA_HOME` 是一个环境变量，其中包含 Java 安装的位置。通常在安装 Java 时设置。
+
[,bash]
----
cd workdir
cp $JAVA_HOME/lib/security/cacerts ./custom_cacerts
----

. 运行以下 keytool 命令添加证书。所需密码为`changeit` 。别名必须是证书的唯一别名，例如不带任何点的域名本身。
+
[,bash]
----
keytool -import -keystore custom_cacerts -alias <a-name-for-the-certificate>  -file site.cert
----

. `custom_cacerts` 存储文件现在将包括`site.cert` 证书。您可以通过在
+
[,bash]
----
keytool -list -keystore custom_cacerts
----

==== 使用 Docker JVM

如果电脑上没有安装 JVM，可以使用 JVM Docker 镜像。应检索证书并将其保存为文件`site.cert` 。

. 创建工作目录`workdir` ，并将证书文件`site.cert` 复制到该目录。
. 启动 Java Docker 容器，将`workdir` 安装为卷，以便可以访问：
+
[,bash]
----
docker run -it -v `pwd`/workdir:/workdir  adoptopenjdk:11 bash
----

. 将目录更改为`workdir` ，并复制`cacerts` 文件：
+
[,bash]
----
cd /workdir
cp $JAVA_HOME/lib/security/cacerts ./custom_cacerts
----

. 运行以下 keytool 命令添加证书。所需密码为`changeit` 。别名必须是证书的唯一别名，例如不带任何点的域名本身。
+
[,bash]
----
keytool -import -keystore custom_cacerts -alias <a-name-for-the-certificate>  -file site.cert
----

. `custom_cacerts` 存储文件现在将包括`site.cert` 证书。您可以通过在
+
[,bash]
----
 keytool -list -keystore custom_cacerts
----

=== 使用自定义信任存储

可以将信任存储和密码指定为值。信任存储只能通过 helm 命令行指定，因为它是一个文件。密码值的指定方式与示例中相同，但也可以通过`values.yaml` 文件提供。

[,bash]
----
helm upgrade \
  --install \
  --namespace suse-observability \
  --values values.yaml \
  --set-file 'stackstate.java.trustStore'=custom_cacerts \
  --set 'stackstate.java.trustStorePassword'=changeit \
suse-observability \
suse-observability/suse-observability
----

[NOTE]
====
*请注意：*

* 首次运行 helm upgrade 命令会导致 pod 重新启动，这可能会造成短暂的可用性中断。
* 在每次运行`helm upgrade` 时都包含这些参数。
* 密码和信任存储作为 Kubernetes 秘密存储。
====


[discrete]
==== Base64 编码的信任存储

如有需要，还可以通过将 Base64 编码字符串传入 Helm 值来配置 Java 信任存储。

[tabs]
====
Linux::
+
--

要使用 base64 编码的信任存储，请运行以下`helm upgrade` 命令：

[,bash]
----
helm upgrade \
  --install \
  --namespace suse-observability \
  --values values.yaml \
  --set 'stackstate.java.trustStoreBase64Encoded'=$(cat custom_cacerts | base64 -w0) \
  --set 'stackstate.java.trustStorePassword'=changeit \
suse-observability \
suse-observability/suse-observability
----

--
MacOs::
+
--

要使用 base64 编码的信任存储，请运行以下`helm upgrade` 命令：

[,bash]
----
helm upgrade \
  --install \
  --namespace suse-observability \
  --values values.yaml \
  --set 'stackstate.java.trustStoreBase64Encoded'=$(cat custom_cacerts | base64) \
  --set 'stackstate.java.trustStorePassword'=changeit \
suse-observability \
suse-observability/suse-observability
----

--
====

=== 通过浏览器获取证书

证书可直接从 Chrome 浏览器下载。所涉及的步骤可能会根据您使用的版本略有不同：

. 导航到需要证书的 URL。
. 单击位置栏中的挂锁图标。
. 点击*证书*。
. 选择*详细信息*。
. 选择*导出*。
. 使用默认导出文件类型（Base64 ASCII 编码）保存。

== SUSE Observability Agent

xref:k8s-suse-rancher-prime.adoc#_installing_the_suse_observability_agent[SUSE Observability Agent]通过 HTTPS 连接到 SUSE Observability Server。如果服务器使用自签名证书，则必须配置代理信任该证书，以建立安全连接。

[NOTE]
====
当服务器使用由私人证书颁发机构 (CA) 签发的证书时，也需要进行此配置。在这种情况下，请使用下文所述的相同方法添加私人 CA 证书。
====

=== 配置自定义证书

使用这两种方法之一，通过 Helm 图表值配置自定义证书：

==== 方法 1：直接 PEM 数据

直接在 Helm 配置中嵌入证书数据：

[,yaml]
----
global:
  customCertificates:
    enabled: true
    pemData: |
      -----BEGIN CERTIFICATE-----
      MIIDrzCCApegAwIBAgIUDMPkLOLGJ12438MbI32eykbw2xowDQYJKoZIhvcNAQEL
      BQAwKTEnMCUGA1UEAwwedmlsaWFrb3Yuc2FuZGJveC5zdGFja3N0YXRlLmlvMB4X
      DTI1MDcxNzEzMjgzN1oXDTI2MDcxNzEzMjgzN1owKTEnMCUGA1UEAwwedmlsaWFr
      b3Yuc2FuZGJveC5zdGFja3N0YXRlLmlvMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A
      MIIBCgKCAQEA0MIdPOxrCpXB+F6P6NY7MyOimuViVWJGDW9ckz4mXZYCJD4iqrKS
      Y4bP6ODO4BgWxKFElxNdwNIqhLmI7RR1MWSRo47oxwPLnqw3INlsX0t1rBp6k6zK
      K4YY+wGdUH/keug03uMS7HxBXEmhCaMnGPj2BBfB4URc41DkFexGU/Fi1cyv0aCq
      CgxbThN/fGSGN2evLuabk9mfw4AH3K8isQ+kS9i3O459BgDGH8yjbrWfBUdPXVx5
      iFiYjGJjVM0pTP1dNriTc88lpajXRK++6O2gmjL9kbf0PGzRsvqqVgI07yR8uV1I
      0MaUwM2/VJrVB6t80wBuC1Tiv+RiYmtJXwIDAQABo4HOMIHLMB0GA1UdDgQWBBSh
      iKBCmrp8jHSCMvUnHv/Wgg7LyDAfBgNVHSMEGDAWgBShiKBCmrp8jHSCMvUnHv/W
      gg7LyDAPBgNVHRMBAf8EBTADAQH/MHgGA1UdEQRxMG+CHnZpbGlha292LnNhbmRi
      b3guc3RhY2tzdGF0ZS5pb4Ijb3RscC12aWxpYWtvdi5zYW5kYm94LnN0YWNrc3Rh
      dGUuaW+CKG90bHAtaHR0cC12aWxpYWtvdi5zYW5kYm94LnN0YWNrc3RhdGUuaW8w
      DQYJKoZIhvcNAQELBQADggEBAIuBFVqJsJImOB4thRk+FFd7UJlK1kQna9woKv23
      ju+fpEWgZZQ0U/xGS9f3JvxCUJv8oj3HYkfPQQgtPmewATVBx2cTRpogV6JFcAo7
      fPSLCzOuSt3c4SM1OtDnyToUaAf6YQQT4m+V4IKb6Qo0XWfCxhkuKJlOfmDtqNg/
      uVYjfG7KOZs6CTJwqdIwpNDbLD+DNfo3b/c731Qa1b9o8Z8rIrNrYXj4kly3D1
      97QiVJCL0u/fC+/KsUxq9ynAYSPgyd2CBnxnQDcq8aQATVTlAafSfk0shvucgQmJ
      KIL9xaM3iTdvrWGtWeAiEQocsRBJM5xjqtnu0R5xDlLU/TQ=
      -----END CERTIFICATE-----
----

==== 方法 2：ConfigMap 参考

用证书创建 Kubernetes ConfigMap，并在 Helm 配置中引用它：

[,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: tls-config
data:
  tls.crt: |
    -----BEGIN CERTIFICATE-----
    [Your certificate content here]
    -----END CERTIFICATE-----
----

在 Helm 配置中引用 ConfigMap：

[,yaml]
----
global:
  customCertificates:
    enabled: true
    configMapName: "tls-config"
----

=== 使用自定义证书进行部署

==== 使用直接的 PEM 数据

对于直接使用 PEM 数据的方法，首先将证书存储在 shell 变量中：

[,bash]
----
export CERT_DATA=$(cat <<'EOF'
-----BEGIN CERTIFICATE-----
[Your certificate content here]
-----END CERTIFICATE-----
EOF
)
----

使用证书配置部署代理：

[,bash]
----
helm upgrade --install \
  --namespace suse-observability \
  --create-namespace \
  --set-string 'stackstate.apiKey'='YOUR_API_KEY' \
  --set-string 'stackstate.cluster.name'='YOUR_CLUSTER_NAME' \
  --set-string 'stackstate.url'='YOUR_SUSE_OBSERVABILITY_URL' \
  --set 'global.customCertificates.enabled'=true \
  --set 'global.customCertificates.pemData'="$CERT_DATA" \
  suse-observability-agent suse-observability/suse-observability-agent
----

==== 使用 ConfigMap 引用

对于 ConfigMap 方法，创建包含证书的 ConfigMap：

[,bash]
----
kubectl create configmap tls-config \
  --from-file=tls.crt=your-certificate.crt \
  --namespace suse-observability
----

使用 ConfigMap 引用部署代理：

[,bash]
----
helm upgrade --install \
  --namespace suse-observability \
  --create-namespace \
  --set-string 'stackstate.apiKey'='YOUR_API_KEY' \
  --set-string 'stackstate.cluster.name'='YOUR_CLUSTER_NAME' \
  --set-string 'stackstate.url'='YOUR_SUSE_OBSERVABILITY_URL' \
  --set 'global.customCertificates.enabled'=true \
  --set 'global.customCertificates.configMapName'='tls-config' \
  suse-observability-agent suse-observability/suse-observability-agent
----

== SUSE Observability CLI

xref:setup/cli/cli-sts.adoc[SUSE Observability CLI]通过 HTTPS 连接到 SUSE Observability Server。当服务器使用自签名证书或私人证书颁发机构 (CA) 颁发的证书时，配置 CLI 以信任这些证书。

=== 配置自定义 CA 证书

使用其中一种方法配置自定义 CA 证书：

* **持久配置**：使用`sts context save` 保存证书配置，以备将来执行命令时使用
* **一次性使用**：必要时为个别 CLI 命令添加证书标记

==== 方法 1：CA 证书文件路径

指定 PEM 编码 CA 证书文件的路径：

[,bash]
----
sts context save \
  --name staging \
  --url https://staging.internal \
  --api-token YOUR_API_TOKEN \
  --ca-cert-path /path/to/ca.crt
----

==== 方法 2：Base64 编码的 CA 证书数据

以 base64 编码字符串的形式提供 CA 证书数据：

[,bash]
----
sts context save \
  --name staging \
  --url https://staging.internal \
  --api-token YOUR_API_TOKEN \
  --ca-cert-base64-data BASE64_ENCODED_CERTIFICATE_DATA
----

==== 与其他命令一起使用 CA 证书

在任何 CLI 命令中使用证书标志可进行一次性证书验证：

[,bash]
----
# Using certificate file path
sts agent list \
  --url https://staging.internal \
  --api-token YOUR_API_TOKEN \
  --ca-cert-path /path/to/ca.crt

# Using base64-encoded certificate data
sts settings list \
  --url https://staging.internal \
  --api-token YOUR_API_TOKEN \
  --ca-cert-base64-data BASE64_ENCODED_CERTIFICATE_DATA
----

=== 配置优先级

当同时提供两个证书选项时，文件路径 (`--ca-cert-path`) 优先于 base64 数据 (`--ca-cert-base64-data`) 。

=== 存储

证书配置存储在 `~/.config/stackstate-cli/config.yaml`

[NOTE]
====
**重要**：`--skip-ssl` 标志会禁用所有 SSL 验证并忽略证书配置。始终使用 CA 证书选项来确保使用自定义证书的安全连接。
====

== SUSE Observability 开放遥测技术

=== 为自定义证书颁发机构创建配置图

----
kubectl create configmap tls-config \
  --namespace open-telemetry \
  --from-file=tls.crt=<your-certificate>
----

. 在`otel-collector.yaml` 的顶层添加以下内容，挂载 configmap：

----
# Mounting volume for CA certificate
extraVolumes: 
  - name: tls-config
    configMap:
      items:
        - key: tls.crt
          path: tls.crt
      name: tls-config
extraVolumeMounts:
  - mountPath: "/certs"
    name: tls-config
    readOnly: true
----

. 通过添加`tls.ca_file` 密钥，更新`otel-collector.yaml` 中的导出器配置，以使用证书*ca_file*：

----
otlp/suse-observability:
  auth:
    authenticator: bearertokenauth
  # Put in your own otlp endpoint, for example suse-observability.my.company.com:443
  endpoint: <your-endpoint>
  compression: snappy
  tls:
    ca_file: /certs/tls.crt
----

. 安装（或升级）您的 Open Telemetry 采集器。

== 针对 SUSE Observability 的 Rancher UI 扩展

为 SUSE Observability 安装 Rancher UI 扩展时（请参阅xref:/k8s-suse-rancher-prime.adoc#_installing_ui_extensions[安装 UI 扩展]），扩展必须与 SUSE Observability Server 通信。如果服务器使用自签名证书，扩展安装将失败。

**解决方案**在安装扩展前将自定义证书添加到 Rancher。请遵循 Rancher 文档：https://ranchermanager.docs.rancher.com/getting-started/installation-and-upgrade/resources/custom-ca-root-certificates[配置自定义 CA 根证书^]。

在 Rancher 中配置证书后，扩展将成功连接到 SUSE Observability Server。
