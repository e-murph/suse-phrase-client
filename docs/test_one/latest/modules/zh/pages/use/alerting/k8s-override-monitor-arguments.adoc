= 通过 kubernetes 注释覆盖监控器阈值参数
:revdate: 2025-07-10
:page-revdate: {revdate}
:description: SUSE 可观察性

== 概述

SUSE Observability 提供xref:/use/alerting/k8s-monitors.adoc[开箱即用的监控器]，可监控 Kubernetes 集群中可能出现的常见问题。这些监视器使用某些默认参数，适合大多数用例，但有时需要通过覆盖某些默认参数（如`threshold` 或`failureState` ）来调整其行为。
声明重载的机制是通过 kubernetes 资源注解来实现的，这些注解表示重载应适用于哪个监控器和组件。例如，我们可以为特定服务重写`Available service endpoints` 监控程序的`failureState` ，我们希望在服务失败时发出`CRITICAL` 状态信号，而不是默认的`DEVIATING` 。

== 如何

* <<_how_to_build_my_annotation,如何建立我的注释>>
* <<_what_monitors_allow_overriding_arguments,哪些监控器允许覆盖参数？>>
* <<_build_an_override_for_a_custom_monitor,为自定义监视器建立覆盖>>

例如，这些步骤将覆盖用于 Kubernetes HTTP 服务`Available service endpoints` 监控的参数。

== 如何建立我的注释

SUSE Observability 监视器的覆盖注释键遵循以下约定：

----
monitor.${owner}.stackstate.io/${monitorShorName}
----

`owner` 属性表示谁创建了这样一个监视器，对于开箱即用的监视器来说是`kubernetes-v2` ，而`monitorShorName` 属性表示监视器的 ID，可从监视器的`identifier` 属性中提取，在列出或检查监视器时可从客户端读取该属性。

----
sts monitor list

ID              | STATUS  | IDENTIFIER                                                                          | NAME                                        | FUNCTION ID     | TAGS
8051105457030   | ENABLED | urn:stackpack:kubernetes-v2:shared:monitor:kubernetes-v2:service-available-endpoint | Available service endpoints                 | 233276809885571 | [services]
----

在我们的例子中，标识符是`urn:stackpack:kubernetes-v2:shared:monitor:kubernetes-v2:service-available-endpoint` ，而`monitorShorName` 与`service-available-endpoint` 中的最后一个片段相对应，因此注释键是：

[,bash]
----
monitor.kubernetes-v2.stackstate.io/service-available-endpoint
----

注释有效载荷是一个 JSON 对象，可以定义以下可选参数：

* `threshold`：可选。要与之比较的数字阈值。
* `failureState`：可选。要么是 "关键"，要么是 "偏离"。在 SUSE Observability 中，"CRITICAL "将显示为读取状态，而 "DEVIATING "则显示为橙色，以表示不同的严重程度。
* `enabled`：可选。布尔值，用于确定监控器是否会为该组件生成健康状态。

完整的注释如下

[,bash]
----
    monitor.kubernetes-v2.stackstate.io/service-available-endpoint: |-
      {
        "threshold": 0.0,
        "failureState": "CRITICAL",
        "enabled": true
      }
----

== 哪些监控器允许覆盖参数？

* xref:/use/alerting/kubernetes-monitors.adoc#_available_service_endpoints[可用服务端点]
* xref:/use/alerting/kubernetes-monitors.adoc#_cpu_limits_resourcequota[Cpu 限制 资源配额]
* xref:/use/alerting/kubernetes-monitors.adoc#_cpu_requests_resourcequota[CPU 请求资源配额]
* xref:/use/alerting/kubernetes-monitors.adoc#_memory_limits_resourcequota[内存限制 resourcequota]
* xref:/use/alerting/kubernetes-monitors.adoc#_memory_requests_resourcequota[内存请求 资源配额]
* xref:/use/alerting/kubernetes-monitors.adoc#_node_disk_pressure[节点磁盘压力]
* xref:/use/alerting/kubernetes-monitors.adoc#_node_memory_pressure[节点内存压力]
* xref:/use/alerting/kubernetes-monitors.adoc#_node_pid_pressure[节点 PID 压力]
* xref:/use/alerting/kubernetes-monitors.adoc#_node_readiness[节点就绪]
* xref:/use/alerting/kubernetes-monitors.adoc#_orphaned_persistent_volumes[孤岛持久卷]（仅`enabled` 属性）
* xref:/use/alerting/kubernetes-monitors.adoc#_out_of_memory_for_containers[容器内存不足]
* xref:/use/alerting/kubernetes-monitors.adoc#_http_5xx_error_ratio[HTTP - 5xx 错误率]
* xref:/use/alerting/kubernetes-monitors.adoc#_http_response_time_q95_is_above_3_seconds[HTTP - 响应时间 - Q95 超过 3 秒]

== 为自定义监视器建立覆盖

xref:/use/alerting/k8s-add-monitors-cli.adoc[使用 CLI 向组件添加阈值监控器]指南创建的任何自定义阈值xref:/use/alerting/k8s-add-monitors-cli.adoc[监控器]都适合覆盖参数，如xref:/use/alerting/k8s-add-monitors-cli.adoc#_write_the_outline_of_the_monitor[示例所示]，自定义监控器的标识符结构为``+urn:custom:monitor:{monitorShortName}``+，此类标识符的覆盖注释键预计为

[,bash]
----
monitor.custom.stackstate.io/${monitorShortName}
----

该示例使用的标识符是`urn:custom:monitor:deployment-has-replicas` ，因此注释键将是

[,bash]
----
monitor.custom.stackstate.io/deployment-has-replicas
----

完整的注释如下

[,bash]
----
    monitor.custom.stackstate.io/deployment-has-replicas: |-
      {
        "threshold": 0.0,
        "failureState": "CRITICAL"
        "enabled": true
      }
----
