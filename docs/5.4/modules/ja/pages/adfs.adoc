= SAML (ADFS)
:revdate: 2025-05-08
:page-revdate: {revdate}
:page-opendocs-origin: /08.integration/06.adfs/06.adfs.md
:page-opendocs-slug:  /統合/adfs

== ADFS と{product-name} の統合の設定

このセクションでは、まずADFSでのセットアップ手順を説明し、次に{product-name} コンソールでのセットアップ手順を説明します。

=== ADFSセットアップ

. AD FS 管理から、"`Relying Party Trusts`" を右クリックし、"`Add Relying Party Trust...`" を選択する。
+
image:adfs1.png[adfsSetup]

. ウェルカムステップから"`Start`" ボタンを選択します。
+
image:adfs2.png[adfsSetup]

. "`Enter data about the relying party manually`" を選択し、"`Next`" を選択する。
+
image:adfs3.png[adfsSetup]

. 表示名フィールドに一意の名前を入力し、"`Next`" を選択します。
+
image:adfs4.png[adfsSetup]

. トークンの暗号化をスキップするには、"`Next`" を選択します。
+
image:adfs5.png[adfsSetup]

. "`Enable support for the SAML 2.0 WebSSO protocol`" をチェックし、{product-name} Settings>SAML Setting ページから SAML Redirect URI を"`Relying party SAML 2.0 SSO service URL`" フィールドに入力する。 "`Next`" 。
+
image:adfs6.png[adfsSetup]

. 同じ SAML リダイレクト URI を"`Relying party trust identifier`" フィールドに入力し、"`Add`" をクリックする。"`Next`" を選択して続行する。
+
image:adfs7.png[adfsSetup]

. Customize Access Control（アクセス制御のカスタマイズ）を選択し、"`Next`" を選択して続行します。
+
image:adfs8.png[adfsSetup]

. "`Next`" 。
+
image:adfs9.png[adfsSetup]

. "`Close`" 。
. クレーム発行ポリシーの編集を選択...
+
image:adfs10-11.png[adfsSetup]

. "`Add Rule...`" を選択し、"`Send LDAP Attributes as Claims`" を選択する。次に"`Next`" を選択する。 ルールに名前を付け、属性ストアとしてActive Directoryを選択する。デフォルトのロールが設定されている場合、認証に必要なのはUsername outgoing claimのみである。 Eメールは任意。
+
--
* SAM-Account-Name-> ユーザー名
* 電子メールアドレス-> 電子メール
* Token-Groups-- Unqalified names-> groups（トークン・グループ）。

image:adfs11-12.png[adfsSetup]
--
. "`Add Rule...`" を選択し、"`Transform an Incoming Claim`" を選択する。次に"`Next`" を選択する。 以下のスクリーンショットのように、ルールに名前を付け、フィールドを設定する。 送信名IDの形式はTransient Identifierである必要がある。
+
image:adfs12-13.png[adfsSetup]

=== {product-name} セットアップ

. プロバイダーのシングルサインオンURLを特定する
* AD FS Management > Service からエンドポイントを表示し、"`SAML 2.0/WS-Federation`" エンドポイント URL を使用する。
* 例 `https://<adfs-fqdn>/adfs/ls`

. ID プロバイダ 発行者
* AD FS 管理コンソールから AD FS を右クリックし、"`Edit Federation Service Properties...`" を選択する。"`Federation Service identifier`" を使用する。
* 例 `http://<adfs-fqdn>/adfs/services/trust`

. X.509証明書
* AD FS管理から、サービス > 証明書を選択し、トークン署名証明書を右クリックして選択します。 "`View Certificate...`"
* 詳細タブを選択し "`Copy to File`"
* Base-64エンコードされたx.509（.CER）ファイルとして保存する。
* ファイルの内容をコピーし、X.509 Certificateフィールドに貼り付ける。

. 団体請求
* グループの送信クレーム名を入力
* 例：グループ

. デフォルトの役割
* どの認証ユーザにもデフォルトのロールを許可したい場合を除き、"`None`" 。

. 役割マップ
* 適切な役割のユーザーのグループ名を設定する。 (下のスクリーンショットの例を参照）。
+
image:nv_adfs1.png[NVadfsSetup]

=== グループをロールと名前空間にマッピングする

{product-name} 、グループをプリセット・ロールやカスタム・ロール、ネームスペースにマッピングする方法については、xref:users.adoc#_mapping_groups_to_roles_and_namespaces[「ユーザーとロール」の]セクションを参照してください。

== トラブルシューティング

. ADFS SamlResponseSignature は MessageOnly または MessageAndAssertion のいずれかにする必要がある。 検証または更新するには、Get-AdfsRelyingPartyTrust コマンドを使用する。
+
image:nv_adfs2.png[adfsTroubleshooting]

. Kubernetesノード×ADFSサーバ間の時刻同期

認証を成功させるためには、KubernetessノードとADFSサーバー間の時刻は、時刻同期やクロックドリフトの問題を避けるために同じである必要があります。

https://en.wikipedia.org/wiki/Network_Time_Protocol[] NTP使用し、すべてのサーバーで同じ時刻を設定することをお勧めします。

ADFSと{product-name} の両方のホストが同期しており、潜在的な遅延が10秒を超えていないことを確認してください。LinuxとWindowsのコマンドを使って、日付、時刻、NTPサーバーのアクティビティをチェックできる。

[TIP]
====
以下のように、{product-name} UIで設定を無効にし、再度有効にすることで、認証回数を再ロードすることができる：

* 管理者ユーザーで{product-name} にログイン
* 設定
* ボタンをクリックして、SAML 設定を無効または有効にする。
** *コンフィギュレーション設定は必ず維持してください！*

設定が再度有効になると、ADFSユーザーでログインを試すことができます。うまくいけば、この問題はKubernetesノードとADFSサーバー間の時刻同期エラーによるものであることが確認できる。
====

. {product-name} UI では、SAML 文字は大文字と小文字を区別する必要がある。
+
属性名は大文字と小文字を区別する。ここで構成する SAML 属性名が、アプリケーション構成と完全に一致していることを確認する。SAML は、認証のために正しい URL を指す必要がある。
+
`{product-name} UI -> Settings -> SAML Settings` のフィールドはすべて大文字と小文字を区別する。
+
{product-name} コントローラのログには、ADFSサーバーとの認証に関する関連情報と、根本原因の特定に役立つエラーが含まれています。ログインに失敗した状態を再現し、ログを確認することをお勧めします。

. 正しいグループ、証明書、プロトコルを入力してください。
+
SAML 設定は、以下の構成と一致する必要がある：
+
|===
| セッティング | 価値

| プロバイダーのシングルサインオンURLを特定する
| HTTPSプロトコルが必要

| ID プロバイダ 発行者
| HTTPプロトコルが必要

| ADFS SamlResponseSignature
| MessageOnlyまたはMessageAndAssertionのいずれかにする必要がある。
|===

[CAUTION]
====
これらの設定は、ADFSサーバーと{product-name} UIで検証する必要があります。
====

選択した証明書が有効であり、`CA Root` および`Intermediate Certificates` を含めて正しく生成されている必要がある。信頼できる認証局、Windows、またはhttps://letsencrypt.org/[] LetsEncryptのような自動化ツールを使用して生成できます。

これらのパラメータのいずれかが正しくない場合、SAML 認証を使用して ADFS ユーザで{product-name} にログインしようとすると、`Authentication Failed` エラーが表示されます。
