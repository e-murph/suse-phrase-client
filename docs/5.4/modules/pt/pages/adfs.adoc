= SAML (ADFS)
:revdate: 2025-05-08
:page-revdate: {revdate}
:page-opendocs-origin: /08.integration/06.adfs/06.adfs.md
:page-opendocs-slug:  /integração/adfs

== Configuração da integração do ADFS e {product-name} 

Esta seção descreve primeiro as etapas de configuração no ADFS e, em seguida, no console {product-name}.

=== Configuração do ADFS

. No AD FS Management, clique com o botão direito do mouse em "`Relying Party Trusts`" e selecione "`Add Relying Party Trust...`".
+
image:adfs1.png[adfsSetup]

. Selecione o botão "`Start`" na etapa de boas-vindas.
+
image:adfs2.png[adfsSetup]

. Selecione "`Enter data about the relying party manually`" e selecione "`Next`".
+
image:adfs3.png[adfsSetup]

. Digite um nome exclusivo no campo Nome de exibição e selecione "`Next`".
+
image:adfs4.png[adfsSetup]

. Selecione "`Next`" para ignorar a criptografia de token.
+
image:adfs5.png[adfsSetup]

. Marque "`Enable support for the SAML 2.0 WebSSO protocol`" e digite o URI de redirecionamento de SAML da página {product-name} Settings>SAML Setting no campo "`Relying party SAML 2.0 SSO service URL`".  Selecione "`Next`" para continuar.
+
image:adfs6.png[adfsSetup]

. Digite o mesmo SAML Redirect URI no campo "`Relying party trust identifier`" e clique em "`Add`"; em seguida, selecione "`Next`" para continuar.
+
image:adfs7.png[adfsSetup]

. Personalize o controle de acesso; em seguida, selecione "`Next`" para continuar.
+
image:adfs8.png[adfsSetup]

. Selecione "`Next`" para continuar.
+
image:adfs9.png[adfsSetup]

. Selecione "`Close`" para concluir.
. Selecione Editar política de emissão de sinistros...
+
image:adfs10-11.png[adfsSetup]

. Selecione "`Add Rule...`" e escolha "`Send LDAP Attributes as Claims`"; em seguida, selecione "`Next`".  Nomeie a regra e escolha Active Directory como o armazenamento de atributos. Somente a reivindicação de saída de nome de usuário será necessária para a autenticação se a função padrão estiver definida; caso contrário, serão necessários grupos para o mapeamento de funções.  O e-mail é opcional.
+
--
* SAM-Account-Name -> Nome de usuário
* Endereço de e-mail -> E-mail
* Token-Groups -- Nomes não qualificados -> groups

image:adfs11-12.png[adfsSetup]
--
. Selecione "`Add Rule...`" e escolha "`Transform an Incoming Claim`"; em seguida, selecione "`Next`".  Nomeie a regra e defina o campo conforme capturado na captura de tela abaixo.  O formato do ID do nome de saída precisa ser Transient Identifier (Identificador transitório).
+
image:adfs12-13.png[adfsSetup]

=== {product-name} Configuração

. Identificar URL de logon único do provedor
* Visualize os pontos de extremidade em AD FS Management > Service e use o URL do ponto de extremidade "`SAML 2.0/WS-Federation`".
* Exemplo: `https://<adfs-fqdn>/adfs/ls`

. Emissor do provedor de identidade
* Clique com o botão direito do mouse no AD FS no console de gerenciamento do AD FS e selecione "`Edit Federation Service Properties...`"; use o "`Federation Service identifier`".
* Exemplo: `http://<adfs-fqdn>/adfs/services/trust`

. Certificado X.509
* No AD FS Management, selecione Service > Certificate (Serviço > Certificado), clique com o botão direito do mouse no certificado de assinatura de token e escolha "`View Certificate...`"
* Selecione a guia Details (Detalhes) e clique em "`Copy to File`"
* Salve-o como um arquivo x.509 (.CER) codificado em Base-64
* Copie e cole o conteúdo do arquivo no campo Certificado X.509

. Reivindicação do grupo
* Digite o nome da reivindicação de saída para os grupos
* Exemplo: grupos

. Função padrão
* Recomenda-se que seja "`None`", a menos que você queira permitir que qualquer usuário autenticado tenha uma função padrão.

. Mapa de funções
* Defina os nomes de grupo dos usuários para a função apropriada.  (Veja o exemplo da captura de tela abaixo).
+
image:nv_adfs1.png[NVadfsSetup]

=== Mapeamento de grupos para funções e espaços de nome

Consulte a seção xref:users.adoc#_mapping_groups_to_roles_and_namespaces[Usuários e funções] para saber como mapear grupos para funções predefinidas e personalizadas, bem como namespaces em {product-name}.

== Solução de problemas

. O ADFS SamlResponseSignature precisa ser MessageOnly ou MessageAndAssertion.  Use o comando Get-AdfsRelyingPartyTrust para verificar ou atualizá-lo.
+
image:nv_adfs2.png[adfsTroubleshooting]

. Sincronização de horário entre nós do Kubernetes x servidor ADFS

Para que a autenticação seja bem-sucedida, o horário entre os nós do Kubernetes e o servidor ADFS precisa ser o mesmo para evitar problemas de sincronização de horário ou de desvio de relógio.

Recomenda-se usar um NTP https://en.wikipedia.org/wiki/Network_Time_Protocol[servidor], com configurações de horário iguais em todos os servidores.

Verifique e confirme se os hosts ADFS e {product-name} estão sincronizados e se os possíveis atrasos não excedem mais de 10 segundos. Você pode usar comandos do Linux e do Windows para verificar datas, horários e a atividade do servidor NTP.

[TIP]
====
Você pode recarregar os tempos de autenticação desativando e ativando novamente a configuração na interface do usuário {product-name} da seguinte forma:

* Faça login em {product-name} com o usuário administrador
* Ir para Configurações
* Clique no botão para desativar e ativar a configuração SAML
** *Certifique-se de manter as definições de configuração!*

Depois que a configuração for reativada, você poderá tentar fazer login com um usuário do ADFS. Se funcionar, isso confirma que o problema foi causado por um erro de sincronização de horário entre os nós do Kubernetes e o servidor ADFS.
====

. Os caracteres SAML devem diferenciar maiúsculas de minúsculas na interface do usuário {product-name} 
+
Os nomes de atributos diferenciam maiúsculas de minúsculas. Certifique-se de que qualquer nome de atributo SAML configurado aqui corresponda exatamente à configuração do aplicativo. O SAML deve apontar para o URL correto para autenticação.
+
Todos os campos em `{product-name} UI -> Settings -> SAML Settings` diferenciam maiúsculas de minúsculas.
+
Os registros do controlador {product-name} contêm as informações relevantes sobre a autenticação com o servidor ADFS e os erros que ajudarão a identificar a causa raiz. Recomendamos recriar a condição de login com falha e verificar os registros.

. Certifique-se de inserir os grupos, certificados e protocolos corretos
+
As configurações de SAML precisam corresponder à seguinte configuração:
+
|===
| Configuração | Valor

| Identificar URL de logon único do provedor
| Requer o protocolo HTTPS

| Emissor do provedor de identidade
| Requer o protocolo HTTP

| ADFS SamlResponseSignature
| Precisa ser MessageOnly ou MessageAndAssertion
|===

[CAUTION]
====
Essas configurações precisam ser validadas em seu servidor ADFS e na interface do usuário {product-name}.
====

O certificado selecionado precisa ser válido e gerado corretamente, incluindo os endereços `CA Root` e `Intermediate Certificates`. Você pode gerá-los usando sua autoridade de certificação confiável, o Windows ou uma ferramenta de automação, como o https://letsencrypt.org/[LetsEncrypt].

Se algum desses parâmetros estiver incorreto, você receberá um erro `Authentication Failed` ao tentar fazer login em {product-name} com um usuário ADFS usando a autenticação SAML.
